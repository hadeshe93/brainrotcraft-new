# CSV åŸŸåç»Ÿè®¡å·¥å…·

ä¸€ä¸ªç”¨äºä»å¤šä»½ CSV æ–‡ä»¶ä¸­æå–ã€ç»Ÿè®¡å’Œåˆ†æåŸŸåçš„å·¥å…·ã€‚

## åŠŸèƒ½ç‰¹æ€§

- âœ… è‡ªåŠ¨æ‰«æç›®å½•ä¸­çš„æ‰€æœ‰ CSV æ–‡ä»¶
- âœ… è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç¼–ç ï¼ˆUTF-8ã€GBK ç­‰ï¼‰
- âœ… ä» "Source url" åˆ—æå–åŸŸå
- âœ… ç»Ÿè®¡åŸŸåå‡ºç°é¢‘æ¬¡
- âœ… æŒ‰é¢‘æ¬¡è¿‡æ»¤å’Œæ’åº
- âœ… ä¸ºæ¯ä¸ªåŸŸåéšæœºé€‰æ‹©ç¤ºä¾‹ URL
- âœ… è¾“å‡ºæ ¼å¼åŒ–çš„ CSV æŠ¥å‘Š
- âœ… å®æ—¶æ˜¾ç¤ºå¤„ç†è¿›åº¦
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶

## å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡ CSV æ–‡ä»¶

ç¡®ä¿ä½ çš„ CSV æ–‡ä»¶åŒ…å« `Source url` åˆ—ï¼ˆç²¾ç¡®åŒ¹é…ï¼ŒS å’Œ u å¤§å†™ï¼Œä¸­é—´æœ‰ç©ºæ ¼ï¼‰ã€‚

ç¤ºä¾‹ CSV æ ¼å¼ï¼š
```csv
Source url,å…¶ä»–åˆ—1,å…¶ä»–åˆ—2
https://example.com/page1,value1,value2
https://test.com/page2,value3,value4
https://example.com/page3,value5,value6
```

### 2. è¿è¡Œå·¥å…·

æœ‰ä¸¤ç§æ–¹å¼è¿è¡Œå·¥å…·ï¼š

#### æ–¹å¼ä¸€ï¼šå‘½ä»¤è¡Œç›´æ¥è¿è¡Œ

```bash
pnpm run:tools <CSVæ–‡ä»¶å¤¹è·¯å¾„> <æœ€å°å‡ºç°æ¬¡æ•°>
```

ç¤ºä¾‹ï¼š
```bash
# å¤„ç† /Users/hadeshe/data/csv ç›®å½•ï¼Œè¿‡æ»¤å‡ºç° 2 æ¬¡åŠä»¥ä¸Šçš„åŸŸå
pnpm run:tools /Users/hadeshe/data/csv 2
```

#### æ–¹å¼äºŒï¼šåœ¨ä»£ç ä¸­å¯¼å…¥ä½¿ç”¨

```typescript
import { processCsvDomains } from './tools/index.js';

// å¤„ç† CSV æ–‡ä»¶
const success = await processCsvDomains(
  '/Users/hadeshe/data/csv',  // CSV æ–‡ä»¶ç›®å½•
  2                             // æœ€å°‘å‡ºç° 2 æ¬¡
);

if (success) {
  console.log('âœ… å¤„ç†å®Œæˆï¼ç»“æœå·²ä¿å­˜åˆ° tools/output.csv');
} else {
  console.error('âŒ å¤„ç†å¤±è´¥');
}
```

### 3. æŸ¥çœ‹ç»“æœ

å·¥å…·ä¼šåœ¨ `tools/output.csv` ç”Ÿæˆç»“æœæ–‡ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹åˆ—ï¼š

- **åŸŸååœ°å€**: æå–å‡ºçš„åŸŸåï¼ˆä¿ç•™å®Œæ•´æ ¼å¼ï¼‰
- **å‡ºç°æ¬¡æ•°**: è¯¥åŸŸååœ¨æ‰€æœ‰æ–‡ä»¶ä¸­å‡ºç°çš„æ€»æ¬¡æ•°
- **ç¤ºä¾‹url1**: éšæœºé€‰æ‹©çš„ç¬¬ 1 ä¸ªç¤ºä¾‹ URL
- **ç¤ºä¾‹url2**: éšæœºé€‰æ‹©çš„ç¬¬ 2 ä¸ªç¤ºä¾‹ URLï¼ˆå¦‚æœ‰ï¼‰
- **ç¤ºä¾‹url3**: éšæœºé€‰æ‹©çš„ç¬¬ 3 ä¸ªç¤ºä¾‹ URLï¼ˆå¦‚æœ‰ï¼‰

ç¤ºä¾‹è¾“å‡ºï¼š
```csv
åŸŸååœ°å€,å‡ºç°æ¬¡æ•°,ç¤ºä¾‹url1,ç¤ºä¾‹url2,ç¤ºä¾‹url3
example.com,15,https://example.com/page1,https://example.com/page2,https://example.com/page3
test.com,8,https://test.com/a,https://test.com/b,
another.com,3,https://another.com/x,,
```

## å‚æ•°è¯´æ˜

### processCsvDomains(dirPath, minCount)

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `dirPath` | string | æ˜¯ | CSV æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„ç»å¯¹è·¯å¾„ |
| `minCount` | number | æ˜¯ | åŸŸåæœ€å°‘å‡ºç°æ¬¡æ•°ï¼Œç”¨äºè¿‡æ»¤ä½é¢‘åŸŸå |

**è¿”å›å€¼**: `Promise<boolean>` - å¤„ç†æ˜¯å¦æˆåŠŸ

## è¾“å‡ºç¤ºä¾‹

è¿è¡Œå·¥å…·æ—¶ä¼šæ˜¾ç¤ºè¯¦ç»†çš„è¿›åº¦ä¿¡æ¯ï¼š

```
==================== CSV åŸŸåç»Ÿè®¡å·¥å…· ====================

ğŸ“ è¾“å…¥ç›®å½•: /Users/hadeshe/data/csv
ğŸ”¢ è¿‡æ»¤æ¡ä»¶: åŸŸåå‡ºç°æ¬¡æ•° >= 2

ğŸ” æ‰«æ CSV æ–‡ä»¶...
âœ“ æ‰¾åˆ° 10 ä¸ª CSV æ–‡ä»¶

[1/10] å¤„ç†æ–‡ä»¶: data1.csv
  âœ“ å¤„ç†äº† 1,234 è¡Œæ•°æ®

[2/10] å¤„ç†æ–‡ä»¶: data2.csv
  âœ“ å¤„ç†äº† 567 è¡Œæ•°æ®

...

ğŸ“Š ç»Ÿè®¡åˆ†æ...
âœ“ æ€»åŸŸåæ•°: 456
âœ“ ç¬¦åˆæ¡ä»¶çš„åŸŸåæ•°: 123

ğŸ’¾ ç”Ÿæˆè¾“å‡ºæ–‡ä»¶...
âœ“ è¾“å‡ºæ–‡ä»¶: /Users/hadeshe/.../tools/output.csv

==================== å¤„ç†å®Œæˆ ====================
ğŸ“ å¤„ç†æ–‡ä»¶æ•°: 10
ğŸ“Š æ€»è¡Œæ•°: 12,345
ğŸŒ æ€»åŸŸåæ•°: 456
âœ… ç¬¦åˆæ¡ä»¶çš„åŸŸåæ•°: 123 (å‡ºç° >= 2 æ¬¡)
â±ï¸  å¤„ç†è€—æ—¶: 3.45 ç§’
==============================================
```

## è®¾è®¡ç‰¹ç‚¹

### SOLID åŸåˆ™

æœ¬å·¥å…·ä¸¥æ ¼éµå¾ª SOLID è®¾è®¡åŸåˆ™ï¼š

- **å•ä¸€èŒè´£ (SRP)**: æ¯ä¸ªå‡½æ•°åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„åŠŸèƒ½
- **å¼€é—­åŸåˆ™ (OCP)**: æ˜“äºæ‰©å±•æ–°åŠŸèƒ½ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
- **ä¾èµ–å€’ç½® (DIP)**: ä¾èµ–æŠ½è±¡æ¥å£ï¼Œæ¨¡å—é—´ä½è€¦åˆ

### åˆ†å±‚æ¶æ„

```
ä¸»åè°ƒå±‚ (processCsvDomains)
    â†“
æ–‡ä»¶æ“ä½œå±‚ (getAllCsvFiles, detectFileEncoding, readAndParseCsv)
    â†“
æ•°æ®æå–å±‚ (extractDomainFromUrl, extractSourceUrls)
    â†“
ç»Ÿè®¡åˆ†æå±‚ (collectDomainStatistics, filterByMinimumCount, sortByFrequency)
    â†“
è¾“å‡ºæ ¼å¼åŒ–å±‚ (selectRandomSamples, formatOutputRows, writeCsvOutput)
```

### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### 1. æ–‡ä»¶æ“ä½œå±‚
- `getAllCsvFiles()` - æ‰«æç›®å½•è·å– CSV æ–‡ä»¶
- `detectFileEncoding()` - è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç¼–ç 
- `readAndParseCsv()` - è¯»å–å¹¶è§£æ CSV

#### 2. æ•°æ®æå–å±‚
- `extractDomainFromUrl()` - ä» URL æå–åŸŸåï¼ˆçº¯å‡½æ•°ï¼‰
- `extractSourceUrls()` - ä» CSV è¡Œä¸­æå– URL

#### 3. ç»Ÿè®¡åˆ†æå±‚
- `collectDomainStatistics()` - ç»Ÿè®¡åŸŸåå‡ºç°æ¬¡æ•°
- `mergeDomainStatistics()` - åˆå¹¶å¤šä¸ªæ–‡ä»¶çš„ç»Ÿè®¡ç»“æœ
- `filterByMinimumCount()` - è¿‡æ»¤ä½é¢‘åŸŸå
- `sortByFrequency()` - æŒ‰é¢‘æ¬¡æ’åº

#### 4. è¾“å‡ºæ ¼å¼åŒ–å±‚
- `selectRandomSamples()` - éšæœºé€‰æ‹©ç¤ºä¾‹ URL
- `formatOutputRows()` - æ ¼å¼åŒ–è¾“å‡ºè¡Œ
- `writeCsvOutput()` - å†™å…¥ CSV æ–‡ä»¶

#### 5. è¿›åº¦è·Ÿè¸ªå±‚
- `ProgressTracker` - å°è£…è¿›åº¦æ˜¾ç¤ºå’Œç»Ÿè®¡é€»è¾‘

## é”™è¯¯å¤„ç†

å·¥å…·å…·æœ‰å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

- âœ… **å•ä¸ªæ–‡ä»¶å¤±è´¥ä¸å½±å“æ•´ä½“**: æŸä¸ª CSV æ–‡ä»¶è§£æå¤±è´¥æ—¶ï¼Œä¼šè®°å½•é”™è¯¯å¹¶ç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶
- âœ… **æ— æ•ˆ URL è‡ªåŠ¨è·³è¿‡**: æ— æ³•è§£æçš„ URL ä¼šè¢«è·³è¿‡ï¼Œä¸ä¼šä¸­æ–­å¤„ç†
- âœ… **ç¼–ç è‡ªåŠ¨æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç¼–ç ï¼Œæ”¯æŒ UTF-8ã€GBK ç­‰å¸¸è§ç¼–ç 
- âœ… **æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯**: æ‰€æœ‰é”™è¯¯éƒ½ä¼šæ˜¾ç¤ºæ¸…æ™°çš„æç¤ºä¿¡æ¯

## æ€§èƒ½ä¼˜åŒ–

- âœ… ä½¿ç”¨ `Set` å»é‡ï¼Œé¿å…å­˜å‚¨é‡å¤ URL
- âœ… ä½¿ç”¨ `Map` è¿›è¡Œé«˜æ•ˆçš„åŸŸåæŸ¥æ‰¾
- âœ… æµå¼å¤„ç†ï¼Œå†…å­˜å ç”¨å°

## æ‰©å±•æ€§

å¦‚æœä½ éœ€è¦æ‰©å±•åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š

### æ·»åŠ å­åŸŸåèšåˆåŠŸèƒ½

åªéœ€æ·»åŠ ä¸€ä¸ªæ–°å‡½æ•°ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç ï¼š

```typescript
function normalizeToMainDomain(domain: string): string {
  // æå–ä¸»åŸŸåé€»è¾‘ï¼Œä¾‹å¦‚ www.example.com â†’ example.com
  const parts = domain.split('.');
  if (parts.length > 2) {
    return parts.slice(-2).join('.');
  }
  return domain;
}

// åœ¨ extractDomainFromUrl åè°ƒç”¨
const domain = extractDomainFromUrl(url);
const normalizedDomain = normalizeToMainDomain(domain);
```

### æ·»åŠ æ–°çš„è¿‡æ»¤æ¡ä»¶

å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„è¿‡æ»¤å‡½æ•°ï¼š

```typescript
function filterByDomainLength(stats: DomainStats[], maxLength: number): DomainStats[] {
  return stats.filter(s => s.domain.length <= maxLength);
}
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ‰¾ä¸åˆ° "Source url" åˆ—

**è§£å†³æ–¹æ³•**: æ£€æŸ¥ CSV æ–‡ä»¶çš„åˆ—åæ˜¯å¦ä¸º `Source url`ï¼ˆç²¾ç¡®åŒ¹é…ï¼ŒS å’Œ u å¤§å†™ï¼Œä¸­é—´æœ‰ç©ºæ ¼ï¼‰

### é—®é¢˜ï¼šç¼–ç æ˜¾ç¤ºä¹±ç 

**è§£å†³æ–¹æ³•**: å·¥å…·ä¼šè‡ªåŠ¨æ£€æµ‹ç¼–ç ã€‚å¦‚æœä»æœ‰é—®é¢˜ï¼Œå¯ä»¥æ‰‹åŠ¨è½¬æ¢æ–‡ä»¶ç¼–ç ä¸º UTF-8

### é—®é¢˜ï¼šæ²¡æœ‰ç”Ÿæˆè¾“å‡ºæ–‡ä»¶

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥æ˜¯å¦æœ‰åŸŸåæ»¡è¶³æœ€å°å‡ºç°æ¬¡æ•°æ¡ä»¶
2. æ£€æŸ¥ tools ç›®å½•æ˜¯å¦æœ‰å†™å…¥æƒé™

## ä¾èµ–åŒ…

æœ¬å·¥å…·ä½¿ç”¨ä»¥ä¸‹ä¾èµ–åŒ…ï¼š

- `csv-parse` - CSV è§£æ
- `csv-stringify` - CSV ç”Ÿæˆ
- `chardet` - æ–‡ä»¶ç¼–ç æ£€æµ‹
- `iconv-lite` - ç¼–ç è½¬æ¢

## å¼€å‘æ–‡æ¡£

è¯¦ç»†çš„è®¾è®¡æ–¹æ¡ˆå’Œæ¶æ„æ–‡æ¡£è¯·å‚è€ƒï¼š[tools/PLAN.md](./PLAN.md)

## è®¸å¯è¯

MIT

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-30
**ç‰ˆæœ¬**: 1.0.0
**ä½œè€…**: Claude Code
